<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Gastos">
<meta name="theme-color" content="#08080d">
<meta name="description" content="Control de gastos mensuales">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%236366f1' width='100' height='100' rx='22'/><text y='68' x='50' text-anchor='middle' font-size='55'>üí∞</text></svg>">
<title>Gastos Tracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #08080d;
  --surface: rgba(255,255,255,0.035);
  --surface-border: rgba(255,255,255,0.055);
  --text: #f0f0f5;
  --text-dim: #6b7280;
  --text-muted: #4b5563;
  --accent: #818cf8;
  --accent-glow: rgba(129,140,248,0.35);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html, body { 
  height: 100%; 
  overflow: hidden;
  background: var(--bg); 
  color: var(--text); 
  font-family: 'Outfit', sans-serif;
}

body { position: fixed; width: 100%; }

#app {
  width: 100%;
  max-width: 430px;
  height: 100%;
  margin: 0 auto;
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.bg-orb {
  position: fixed;
  border-radius: 50%;
  pointer-events: none;
  filter: blur(80px);
  z-index: 0;
}
.bg-orb-1 { top: -80px; right: -60px; width: 260px; height: 260px; background: rgba(99,102,241,0.08); }
.bg-orb-2 { bottom: 80px; left: -80px; width: 200px; height: 200px; background: rgba(236,72,153,0.05); }
.bg-orb-3 { top: 40%; right: -40px; width: 160px; height: 160px; background: rgba(52,211,153,0.04); }

.scroll-area {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  -webkit-overflow-scrolling: touch;
  padding: 0 22px;
  padding-top: max(56px, env(safe-area-inset-top, 56px));
  padding-bottom: 150px;
  position: relative;
  z-index: 1;
  scrollbar-width: none;
}
.scroll-area::-webkit-scrollbar { display: none; }

.label { font-size: 12px; color: var(--text-dim); letter-spacing: 2px; font-weight: 500; margin-bottom: 6px; }
.page-title {
  font-size: 32px;
  font-weight: 800;
  letter-spacing: -0.8px;
  margin-bottom: 24px;
  background: linear-gradient(135deg, #e0e0ff 20%, var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.month-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 18px;
  margin-bottom: 26px;
}
.month-arrow {
  width: 42px; height: 42px;
  border-radius: 14px;
  border: 1px solid var(--surface-border);
  background: var(--surface);
  color: var(--accent);
  font-size: 20px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  -webkit-appearance: none;
  font-family: inherit;
}
.month-arrow:active { transform: scale(0.92); background: rgba(129,140,248,0.1); }
.month-label { font-size: 17px; font-weight: 600; min-width: 170px; text-align: center; color: #ddd; }

.balance-card {
  background: var(--surface);
  border: 1px solid var(--surface-border);
  border-radius: 26px;
  padding: 26px 22px;
  margin-bottom: 28px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s;
}
.balance-card:active { transform: scale(0.985); }
.balance-card .card-glow {
  position: absolute;
  top: -50px; right: -50px;
  width: 140px; height: 140px;
  border-radius: 50%;
  pointer-events: none;
  transition: background 0.4s;
}
.balance-label { font-size: 11.5px; letter-spacing: 1.2px; color: var(--text-dim); font-weight: 500; margin-bottom: 8px; }
.balance-amount { font-size: 42px; font-weight: 900; color: #fff; letter-spacing: -2px; margin-bottom: 22px; line-height: 1; }
.progress-bg { height: 7px; border-radius: 4px; background: rgba(255,255,255,0.055); margin-bottom: 14px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 4px; transition: width 0.9s cubic-bezier(0.16,1,0.3,1), background 0.4s; }
.budget-row { display: flex; justify-content: space-between; font-size: 12.5px; }
.budget-row span:first-child { color: var(--text-dim); }
.budget-remaining { font-weight: 600; }
.budget-positive { color: #34d399; }
.budget-negative { color: #ef4444; }

.section-title { font-size: 19px; font-weight: 700; color: #ddd; margin-bottom: 16px; letter-spacing: -0.3px; }

.cat-card {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 15px 16px;
  border-radius: 18px;
  background: var(--surface);
  border: 1px solid var(--surface-border);
  margin-bottom: 9px;
  cursor: pointer;
  transition: all 0.2s;
  animation: fadeSlideIn 0.4s ease both;
}
.cat-card:active { transform: scale(0.98); background: rgba(255,255,255,0.055); }
.cat-icon-box {
  width: 46px; height: 46px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
}
.cat-info { flex: 1; min-width: 0; }
.cat-name { font-size: 14.5px; font-weight: 600; color: #e2e2e8; margin-bottom: 3px; }
.cat-pct { font-size: 11.5px; color: var(--text-dim); margin-bottom: 5px; }
.cat-bar { height: 3px; border-radius: 2px; background: rgba(255,255,255,0.05); overflow: hidden; }
.cat-bar-fill { height: 100%; border-radius: 2px; transition: width 0.7s cubic-bezier(0.16,1,0.3,1); }
.cat-amount { font-size: 15.5px; font-weight: 700; color: var(--text); flex-shrink: 0; }

.expense-item {
  display: flex;
  align-items: center;
  gap: 13px;
  padding: 14px 0;
  border-bottom: 1px solid rgba(255,255,255,0.035);
  animation: fadeSlideIn 0.35s ease both;
}
.expense-desc { font-size: 14.5px; font-weight: 600; color: #e2e2e8; margin-bottom: 2px; }
.expense-meta { font-size: 12px; color: var(--text-dim); }
.expense-amount { font-size: 15px; font-weight: 700; color: var(--text); flex-shrink: 0; margin-right: 8px; }
.delete-btn {
  width: 34px; height: 34px;
  border-radius: 10px;
  border: none;
  background: rgba(239,68,68,0.1);
  color: #ef4444;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  font-family: inherit;
  transition: all 0.15s;
}
.delete-btn:active { background: rgba(239,68,68,0.25); transform: scale(0.9); }
.delete-btn.confirm { background: rgba(239,68,68,0.3); }

.stat-card {
  background: var(--surface);
  border: 1px solid var(--surface-border);
  border-radius: 20px;
  padding: 20px;
  margin-bottom: 11px;
  animation: fadeSlideIn 0.45s ease both;
}
.stat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.stat-label { font-size: 14.5px; font-weight: 600; color: #e2e2e8; }
.stat-value { font-size: 22px; font-weight: 800; color: #fff; }
.stat-sub { font-size: 12.5px; color: var(--text-dim); }
.stat-breakdown-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.stat-breakdown-header span:first-child { font-size: 20px; }
.stat-breakdown-amount { margin-left: auto; font-size: 16px; font-weight: 700; color: #fff; }

.empty-state { text-align: center; padding: 56px 20px; }
.empty-icon { font-size: 50px; margin-bottom: 16px; opacity: 0.4; }
.empty-text { font-size: 16.5px; color: var(--text-dim); font-weight: 500; }
.empty-sub { font-size: 13.5px; color: var(--text-muted); margin-top: 8px; }

.fab {
  position: absolute;
  bottom: calc(76px + var(--safe-bottom));
  left: 50%;
  transform: translateX(-50%);
  width: 62px; height: 62px;
  border-radius: 20px;
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: #fff;
  border: none;
  font-size: 34px;
  font-weight: 300;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 8px 32px var(--accent-glow);
  z-index: 50;
  transition: all 0.2s;
  font-family: inherit;
  line-height: 1;
  padding-bottom: 2px;
}
.fab:active { transform: translateX(-50%) scale(0.92); }

.bottom-nav {
  position: absolute;
  bottom: 0;
  left: 0; right: 0;
  display: flex;
  justify-content: space-around;
  padding: 12px 0;
  padding-bottom: max(14px, var(--safe-bottom));
  border-top: 1px solid var(--surface-border);
  background: rgba(8,8,13,0.94);
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  z-index: 40;
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  background: none;
  border: none;
  cursor: pointer;
  font-family: inherit;
  padding: 4px 16px;
  transition: all 0.2s;
}
.nav-icon { font-size: 23px; transition: all 0.2s; }
.nav-label { font-size: 10.5px; font-weight: 600; letter-spacing: 0.4px; transition: all 0.2s; }
.nav-item.inactive .nav-icon { opacity: 0.35; }
.nav-item.inactive .nav-label { color: var(--text-dim); opacity: 0.5; }
.nav-item.active .nav-icon { opacity: 1; }
.nav-item.active .nav-label { color: var(--accent); }

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 100;
  opacity: 0;
  transition: opacity 0.3s;
  display: none;
}
.modal-backdrop.open { display: flex; align-items: flex-end; justify-content: center; opacity: 1; }
.modal-sheet {
  width: 100%;
  max-width: 430px;
  background: #12121e;
  border-radius: 28px 28px 0 0;
  padding: 28px 22px 40px;
  max-height: 90vh;
  overflow-y: auto;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
}
.modal-backdrop.open .modal-sheet { transform: translateY(0); }
.modal-handle { width: 42px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.12); margin: 0 auto 22px; }
.modal-title { font-size: 22px; font-weight: 700; text-align: center; margin-bottom: 24px; }

.cat-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 9px;
  margin-bottom: 26px;
}
.cat-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  padding: 12px 2px;
  border-radius: 16px;
  border: 2px solid rgba(255,255,255,0.05);
  background: rgba(255,255,255,0.02);
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.16,1,0.3,1);
  -webkit-appearance: none;
  font-family: inherit;
}
.cat-option:active { transform: scale(0.93); }
.cat-option.selected { transform: scale(1.06); }
.cat-option-icon { font-size: 24px; }
.cat-option-name { font-size: 9.5px; font-weight: 600; color: var(--text-dim); text-align: center; line-height: 1.2; }

.input-label { font-size: 11.5px; color: var(--text-dim); letter-spacing: 1.2px; font-weight: 500; margin-bottom: 8px; }
.input-group { margin-bottom: 18px; }
.text-input {
  width: 100%;
  padding: 16px 18px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.07);
  background: rgba(255,255,255,0.035);
  color: var(--text);
  font-size: 18px;
  font-weight: 600;
  outline: none;
  transition: all 0.2s;
  font-family: 'Outfit', sans-serif;
  -webkit-appearance: none;
}
.text-input:focus { border-color: rgba(129,140,248,0.4); background: rgba(255,255,255,0.055); }
.text-input::placeholder { color: var(--text-muted); font-weight: 400; }

.btn-primary {
  width: 100%;
  padding: 18px;
  border-radius: 18px;
  border: none;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.3px;
  font-family: 'Outfit', sans-serif;
}
.btn-primary.enabled { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; }
.btn-primary.disabled { background: rgba(255,255,255,0.05); color: var(--text-dim); cursor: default; }
.btn-primary:active:not(.disabled) { transform: scale(0.98); }
.btn-cancel {
  width: 100%;
  padding: 16px;
  border: none;
  background: none;
  color: var(--text-dim);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 6px;
  font-family: 'Outfit', sans-serif;
}

.budget-modal-card {
  background: #1a1a2e;
  border-radius: 24px;
  padding: 30px 24px;
  width: 88%;
  max-width: 340px;
}
.budget-modal-card .modal-title { margin-bottom: 20px; }
.budget-modal-card .text-input { text-align: center; font-size: 28px; }

@keyframes fadeSlideIn {
  from { opacity: 0; transform: translateY(14px); }
  to { opacity: 1; transform: translateY(0); }
}
.view-enter { animation: fadeSlideIn 0.35s cubic-bezier(0.16,1,0.3,1) both; }
.stagger-1 { animation-delay: 0ms; }
.stagger-2 { animation-delay: 80ms; }
.stagger-3 { animation-delay: 160ms; }
.stagger-4 { animation-delay: 240ms; }

.install-banner {
  background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));
  border: 1px solid rgba(129,140,248,0.2);
  border-radius: 18px;
  padding: 16px 18px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 14px;
  animation: fadeSlideIn 0.5s ease both;
  animation-delay: 400ms;
}
.install-banner-icon { font-size: 28px; flex-shrink: 0; }
.install-banner-text { font-size: 13px; color: #c4c4d4; line-height: 1.5; }
.install-banner-text strong { color: var(--accent); font-weight: 600; }
.install-banner-close {
  background: none; border: none; color: var(--text-dim); font-size: 18px;
  cursor: pointer; padding: 4px; flex-shrink: 0; font-family: inherit;
}
</style>
</head>
<body>

<div id="app">
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="bg-orb bg-orb-3"></div>

  <div class="scroll-area" id="scrollArea"></div>

  <button class="fab" id="fabBtn" onclick="openAddModal()">+</button>

  <div class="bottom-nav">
    <button class="nav-item active" id="navHome" onclick="switchView('home')">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">Inicio</span>
    </button>
    <button class="nav-item inactive" id="navHistory" onclick="switchView('history')">
      <span class="nav-icon">üìã</span>
      <span class="nav-label">Historial</span>
    </button>
    <button class="nav-item inactive" id="navStats" onclick="switchView('stats')">
      <span class="nav-icon">üìä</span>
      <span class="nav-label">Stats</span>
    </button>
  </div>

  <div class="modal-backdrop" id="addModal">
    <div class="modal-sheet" id="addSheet">
      <div class="modal-handle"></div>
      <div class="modal-title">Nuevo Gasto</div>
      <div class="input-label">CATEGOR√çA</div>
      <div class="cat-grid" id="catGrid"></div>
      <div class="input-group">
        <div class="input-label">MONTO</div>
        <input class="text-input" id="amountInput" type="number" inputmode="numeric" placeholder="$0">
      </div>
      <div class="input-group">
        <div class="input-label">DESCRIPCI√ìN (OPCIONAL)</div>
        <input class="text-input" id="descInput" type="text" placeholder="Ej: Almuerzo con amigos">
      </div>
      <button class="btn-primary disabled" id="addBtn" onclick="addExpense()">Complet√° los campos</button>
      <button class="btn-cancel" onclick="closeAddModal()">Cancelar</button>
    </div>
  </div>

  <div class="modal-backdrop" id="budgetModal" style="align-items:center;">
    <div class="budget-modal-card">
      <div class="modal-title">Editar Presupuesto</div>
      <input class="text-input" id="budgetInput" type="number" inputmode="numeric" placeholder="">
      <button class="btn-primary enabled" onclick="saveBudget()" style="margin-top:22px;">Guardar</button>
      <button class="btn-cancel" onclick="closeBudgetModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
const CATEGORIES = [
  { id: 'food', name: 'Comida', icon: 'üçΩÔ∏è', color: '#FF6B6B' },
  { id: 'transport', name: 'Transporte', icon: 'üöó', color: '#4ECDC4' },
  { id: 'entertainment', name: 'Entretenimiento', icon: 'üé¨', color: '#A78BFA' },
  { id: 'home', name: 'Hogar', icon: 'üè†', color: '#F59E0B' },
  { id: 'health', name: 'Salud', icon: 'üíä', color: '#34D399' },
  { id: 'clothing', name: 'Ropa', icon: 'üëï', color: '#F472B6' },
  { id: 'education', name: 'Educaci√≥n', icon: 'üìö', color: '#60A5FA' },
  { id: 'subscriptions', name: 'Suscripciones', icon: 'üì±', color: '#C084FC' },
  { id: 'savings', name: 'Ahorro', icon: 'üè¶', color: '#FBBF24' },
  { id: 'other', name: 'Otros', icon: 'üì¶', color: '#94A3B8' },
];
const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

let expenses = JSON.parse(localStorage.getItem('gt_expenses') || '[]');
let budget = parseFloat(localStorage.getItem('gt_budget') || '500000');
let currentView = 'home';
let selectedMonth = new Date().getMonth();
let selectedYear = new Date().getFullYear();
let selectedCategory = null;
let deleteConfirmId = null;
let installBannerDismissed = localStorage.getItem('gt_install_dismissed') === '1';

function save() {
  localStorage.setItem('gt_expenses', JSON.stringify(expenses));
  localStorage.setItem('gt_budget', budget.toString());
}

function formatMoney(n) {
  return '$' + Math.round(n).toLocaleString('es-AR');
}

function getCat(id) { return CATEGORIES.find(c => c.id === id) || CATEGORIES[9]; }

function getFiltered() {
  return expenses.filter(e => {
    const d = new Date(e.date);
    return d.getMonth() === selectedMonth && d.getFullYear() === selectedYear;
  });
}

function getByCategory(filtered) {
  const total = filtered.reduce((s, e) => s + e.amount, 0);
  return CATEGORIES.map(cat => {
    const ce = filtered.filter(e => e.category === cat.id);
    const t = ce.reduce((s, e) => s + e.amount, 0);
    return { ...cat, total: t, expenses: ce, percentage: total > 0 ? (t / total) * 100 : 0 };
  }).filter(c => c.total > 0).sort((a, b) => b.total - a.total);
}

const scrollArea = document.getElementById('scrollArea');

function switchView(v) {
  currentView = v;
  document.querySelectorAll('.nav-item').forEach(el => { el.className = 'nav-item inactive'; });
  document.getElementById('nav' + v.charAt(0).toUpperCase() + v.slice(1)).className = 'nav-item active';
  render();
  scrollArea.scrollTop = 0;
}

function changeMonth(delta) {
  selectedMonth += delta;
  if (selectedMonth < 0) { selectedMonth = 11; selectedYear--; }
  if (selectedMonth > 11) { selectedMonth = 0; selectedYear++; }
  deleteConfirmId = null;
  render();
}

function render() {
  const filtered = getFiltered();
  const total = filtered.reduce((s, e) => s + e.amount, 0);
  const byCategory = getByCategory(filtered);
  const bPct = budget > 0 ? Math.min((total / budget) * 100, 100) : 0;
  const remaining = budget - total;
  const bColor = bPct > 80 ? '#EF4444' : bPct > 50 ? '#F59E0B' : '#818cf8';
  const glowColor = bPct > 80 ? 'rgba(239,68,68,0.18)' : 'rgba(129,140,248,0.12)';

  if (currentView === 'home') {
    let installHTML = '';
    if (!installBannerDismissed && !window.navigator.standalone) {
      installHTML = `
        <div class="install-banner">
          <span class="install-banner-icon">üì≤</span>
          <div class="install-banner-text">
            <strong>Instal√° la app:</strong> Toc√° <strong>Compartir</strong> ‚Üó y luego <strong>"Agregar a inicio"</strong>
          </div>
          <button class="install-banner-close" onclick="dismissInstall()">‚úï</button>
        </div>`;
    }

    scrollArea.innerHTML = `
      <div class="view-enter stagger-1">
        <div class="label">MIS FINANZAS</div>
        <div class="page-title">Control de Gastos</div>
      </div>
      <div class="view-enter stagger-2">
        <div class="month-nav">
          <button class="month-arrow" onclick="changeMonth(-1)">‚Äπ</button>
          <div class="month-label">${MONTHS[selectedMonth]} ${selectedYear}</div>
          <button class="month-arrow" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
      </div>
      <div class="view-enter stagger-3">
        <div class="balance-card" onclick="openBudgetModal()">
          <div class="card-glow" style="background:radial-gradient(circle,${glowColor},transparent)"></div>
          <div class="balance-label">GASTADO ESTE MES</div>
          <div class="balance-amount">${formatMoney(total)}</div>
          <div class="progress-bg"><div class="progress-fill" style="width:${bPct}%;background:${bColor}"></div></div>
          <div class="budget-row">
            <span>Presupuesto: ${formatMoney(budget)}</span>
            <span class="budget-remaining ${remaining >= 0 ? 'budget-positive' : 'budget-negative'}">
              ${remaining >= 0 ? 'Quedan ' + formatMoney(remaining) : 'Excedido ' + formatMoney(Math.abs(remaining))}
            </span>
          </div>
        </div>
      </div>
      ${installHTML}
      ${byCategory.length > 0 ? `
        <div class="section-title view-enter stagger-4">Categor√≠as</div>
        ${byCategory.map((cat, i) => `
          <div class="cat-card" style="animation-delay:${300 + i * 55}ms" onclick="switchView('stats')">
            <div class="cat-icon-box" style="background:${cat.color}18">${cat.icon}</div>
            <div class="cat-info">
              <div class="cat-name">${cat.name}</div>
              <div class="cat-pct">${cat.percentage.toFixed(1)}%</div>
              <div class="cat-bar"><div class="cat-bar-fill" style="width:${cat.percentage}%;background:${cat.color}"></div></div>
            </div>
            <div class="cat-amount">${formatMoney(cat.total)}</div>
          </div>
        `).join('')}
      ` : `
        <div class="empty-state view-enter stagger-4">
          <div class="empty-icon">üìä</div>
          <div class="empty-text">Sin gastos este mes</div>
          <div class="empty-sub">Toc√° + para agregar tu primer gasto</div>
        </div>
      `}
    `;
  }

  else if (currentView === 'history') {
    const sorted = [...filtered].sort((a, b) => new Date(b.date) - new Date(a.date));
    scrollArea.innerHTML = `
      <div class="view-enter stagger-1">
        <div class="label">HISTORIAL</div>
        <div class="page-title">Todos los Gastos</div>
      </div>
      <div class="view-enter stagger-2">
        <div class="month-nav">
          <button class="month-arrow" onclick="changeMonth(-1)">‚Äπ</button>
          <div class="month-label">${MONTHS[selectedMonth]} ${selectedYear}</div>
          <button class="month-arrow" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
      </div>
      ${sorted.length > 0 ? sorted.map((exp, i) => {
        const cat = getCat(exp.category);
        const isConfirm = deleteConfirmId === exp.id;
        return `
          <div class="expense-item" style="animation-delay:${180 + i * 35}ms">
            <div class="cat-icon-box" style="background:${cat.color}18">${cat.icon}</div>
            <div style="flex:1;min-width:0">
              <div class="expense-desc">${exp.description}</div>
              <div class="expense-meta">${cat.name} ¬∑ ${new Date(exp.date).toLocaleDateString('es-AR')}</div>
            </div>
            <div class="expense-amount">-${formatMoney(exp.amount)}</div>
            <button class="delete-btn ${isConfirm ? 'confirm' : ''}" onclick="${isConfirm ? `confirmDelete('${exp.id}')` : `askDelete('${exp.id}')`}">
              ${isConfirm ? '‚úì' : '‚úï'}
            </button>
          </div>
        `;
      }).join('') : `
        <div class="empty-state view-enter stagger-3">
          <div class="empty-icon">üìã</div>
          <div class="empty-text">Sin gastos registrados</div>
          <div class="empty-sub">Agreg√° gastos para verlos ac√°</div>
        </div>
      `}
    `;
  }

  else if (currentView === 'stats') {
    const days = new Date(selectedYear, selectedMonth + 1, 0).getDate();
    const avg = filtered.length > 0 ? total / days : 0;
    const maxCat = byCategory.length > 0 ? byCategory[0] : null;

    scrollArea.innerHTML = `
      <div class="view-enter stagger-1">
        <div class="label">ESTAD√çSTICAS</div>
        <div class="page-title">${MONTHS[selectedMonth]} ${selectedYear}</div>
      </div>
      <div class="stat-card view-enter stagger-2">
        <div class="stat-row">
          <span class="stat-label">Gasto Total</span>
          <span class="stat-value">${formatMoney(total)}</span>
        </div>
        <div class="stat-sub">${filtered.length} transaccion${filtered.length !== 1 ? 'es' : ''}</div>
      </div>
      <div class="stat-card view-enter stagger-3">
        <div class="stat-row">
          <span class="stat-label">Promedio Diario</span>
          <span class="stat-value" style="font-size:20px">${formatMoney(avg)}</span>
        </div>
      </div>
      ${maxCat ? `
        <div class="stat-card view-enter stagger-4">
          <div class="stat-row">
            <span class="stat-label">${maxCat.icon} Mayor Gasto</span>
            <span class="stat-value" style="font-size:20px">${formatMoney(maxCat.total)}</span>
          </div>
          <div class="stat-sub">${maxCat.name} ‚Äî ${maxCat.percentage.toFixed(1)}% del total</div>
        </div>
      ` : ''}
      ${byCategory.length > 0 ? `
        <div class="section-title" style="margin-top:16px;animation:fadeSlideIn 0.45s ease both;animation-delay:320ms">Desglose</div>
        ${byCategory.map((cat, i) => `
          <div class="stat-card" style="animation-delay:${380 + i * 55}ms">
            <div class="stat-breakdown-header">
              <span>${cat.icon}</span>
              <span class="stat-label">${cat.name}</span>
              <span class="stat-breakdown-amount">${formatMoney(cat.total)}</span>
            </div>
            <div class="progress-bg"><div class="progress-fill" style="width:${cat.percentage}%;background:${cat.color}"></div></div>
            <div class="stat-sub" style="margin-top:8px">${cat.percentage.toFixed(1)}% del total</div>
          </div>
        `).join('')}
      ` : `
        <div class="empty-state view-enter stagger-3">
          <div class="empty-icon">üìà</div>
          <div class="empty-text">Sin datos para mostrar</div>
        </div>
      `}
    `;
  }
}

function askDelete(id) { deleteConfirmId = id; render(); }
function confirmDelete(id) {
  expenses = expenses.filter(e => e.id !== id);
  deleteConfirmId = null;
  save(); render();
}
function dismissInstall() {
  installBannerDismissed = true;
  localStorage.setItem('gt_install_dismissed', '1');
  render();
}

function openAddModal() {
  selectedCategory = null;
  document.getElementById('amountInput').value = '';
  document.getElementById('descInput').value = '';
  updateAddBtn();
  buildCatGrid();
  document.getElementById('addModal').classList.add('open');
}
function closeAddModal() { document.getElementById('addModal').classList.remove('open'); }

function buildCatGrid() {
  const grid = document.getElementById('catGrid');
  grid.innerHTML = CATEGORIES.map(cat => `
    <button class="cat-option" id="co_${cat.id}" onclick="selectCat('${cat.id}')">
      <span class="cat-option-icon">${cat.icon}</span>
      <span class="cat-option-name">${cat.name}</span>
    </button>
  `).join('');
}

function selectCat(id) {
  selectedCategory = id;
  const cat = getCat(id);
  document.querySelectorAll('.cat-option').forEach(el => {
    el.classList.remove('selected');
    el.style.borderColor = 'rgba(255,255,255,0.05)';
    el.style.background = 'rgba(255,255,255,0.02)';
  });
  const el = document.getElementById('co_' + id);
  el.classList.add('selected');
  el.style.borderColor = cat.color;
  el.style.background = cat.color + '15';
  updateAddBtn();
}

function updateAddBtn() {
  const btn = document.getElementById('addBtn');
  const amt = document.getElementById('amountInput').value;
  if (selectedCategory && amt && parseFloat(amt) > 0) {
    btn.className = 'btn-primary enabled';
    btn.textContent = 'Agregar Gasto';
  } else {
    btn.className = 'btn-primary disabled';
    btn.textContent = 'Complet√° los campos';
  }
}

document.getElementById('amountInput').addEventListener('input', updateAddBtn);

function addExpense() {
  const amt = parseFloat(document.getElementById('amountInput').value);
  if (!selectedCategory || !amt || amt <= 0) return;
  const desc = document.getElementById('descInput').value || getCat(selectedCategory).name;
  expenses.unshift({
    id: Date.now().toString(),
    category: selectedCategory,
    amount: amt,
    description: desc,
    date: new Date(selectedYear, selectedMonth, new Date().getDate()).toISOString(),
  });
  save();
  closeAddModal();
  render();
}

function openBudgetModal() {
  document.getElementById('budgetInput').value = budget;
  document.getElementById('budgetInput').placeholder = budget.toString();
  document.getElementById('budgetModal').classList.add('open');
  setTimeout(() => document.getElementById('budgetInput').focus(), 350);
}
function closeBudgetModal() { document.getElementById('budgetModal').classList.remove('open'); }
function saveBudget() {
  const val = parseFloat(document.getElementById('budgetInput').value);
  if (val && val > 0) budget = val;
  save();
  closeBudgetModal();
  render();
}

document.getElementById('addModal').addEventListener('click', function(e) {
  if (e.target === this) closeAddModal();
});
document.getElementById('budgetModal').addEventListener('click', function(e) {
  if (e.target === this) closeBudgetModal();
});

render();
</script>

<script>
if ('serviceWorker' in navigator) {
  const swCode = `
    const CACHE = 'gastos-v1';
    const URLS = ['/'];
    self.addEventListener('install', e => {
      e.waitUntil(caches.open(CACHE).then(c => c.addAll(URLS)));
      self.skipWaiting();
    });
    self.addEventListener('activate', e => {
      e.waitUntil(caches.keys().then(ks => Promise.all(ks.filter(k => k !== CACHE).map(k => caches.delete(k)))));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
    });
  `;
  const blob = new Blob([swCode], { type: 'application/javascript' });
  navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
}

const manifest = {
  name: 'Gastos Tracker',
  short_name: 'Gastos',
  start_url: '.',
  display: 'standalone',
  background_color: '#08080d',
  theme_color: '#08080d',
  icons: [{
    src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%236366f1" width="100" height="100" rx="22"/><text y="68" x="50" text-anchor="middle" font-size="55">üí∞</text></svg>',
    sizes: '512x512',
    type: 'image/svg+xml'
  }]
};
const mBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
const mLink = document.createElement('link');
mLink.rel = 'manifest';
mLink.href = URL.createObjectURL(mBlob);
document.head.appendChild(mLink);
</script>

</body>
</html>
